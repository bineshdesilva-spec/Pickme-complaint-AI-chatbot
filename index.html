<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PickMe AI Support</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            margin: 0;
            padding: 0;
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>
    
    <!-- Load React and ReactDOM from CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Load Babel standalone for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Your app code -->
    <script type="text/babel" data-type="module">
        const { useState, useRef, useEffect } = React;

        // Types
        const PICKME_KNOWLEDGE_BASE = `
PickMe Official Support Guidelines:

1. DX/Merchant Complaints:
   - Request: Name, Driver ID, ID Number, Contact Number.
   - Response: Forward to the relevant team; a representative will contact them.

2. Registration Delay:
   - Request: Name, ID Number, Contact Number.

3. Bike Availability:
   - Note: Bikes available mostly in Colombo limited areas.
   - If not available: Ask for the area and time it wasn't available.

4. Customer (CX) Complaint (Trip/Rider):
   - Request: Name, Trip ID, Contact Number.
   - Urgent Action: Escalate to relevant department immediately.

5. Refunds/Overcharging:
   - Instruction: Tell user to lodge an in-app complaint via "My Trips" -> "Completed/Cancelled" -> "Trip ID" -> "Complaint/HELP" button.
   - Note: Team gets back within 48 business hours.

6. Lost Items:
   - Action: Request Trip ID and Contact details. Direct to hotlines 1331 or 0114 507507.

7. General Tone:
   - Professional, empathetic, and urgent.
   - Always respond in the SAME language the customer used (Sinhala, English, or Tamil).
   - Hotlines: 1331 (Main), 0114 507507 (Driver/Office).

8. Specific Policies:
   - Drivers demanding cash for card payments: Acknowledge frustration, escalate for inspection.
   - Rude behavior: Apologize deeply, escalate to the team.
   - App bugs: Ask for registered mobile/email and escalate.
`;

        // Gemini Service
        const getChatResponse = async (userMessage, history) => {
          try {
            // Try real API first
            const response = await fetch('/api/chat', {
              method: 'POST',
              headers: { 
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                message: userMessage,
                history: history,
                knowledgeBase: PICKME_KNOWLEDGE_BASE
              })
            });

            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            
            if (data.error) {
              console.error('API Error:', data.error);
              throw new Error(data.error);
            }

            return data.text || "I apologize, I couldn't generate a response. Please try again.";

          } catch (error) {
            console.error("PickMe Bot Error:", error);
            
            // MOCK RESPONSE FOR LOCAL TESTING
            // Remove this section when deploying to production
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
              console.warn('ðŸ§ª Using mock response for local testing');
              
              // Smart mock responses based on user input
              const lowerMessage = userMessage.toLowerCase();
              
              if (lowerMessage.includes('trip') || lowerMessage.includes('complaint')) {
                return "Thank you for contacting PickMe Support. To help you with your trip complaint, I'll need:\n\n1. Your Name\n2. Trip ID\n3. Contact Number\n\nPlease provide these details so our team can investigate immediately.\n\nà¶šà¶»à·”à¶«à·à¶šà¶» à¶”à¶¶à¶œà·š à¶±à¶¸, Trip ID à·ƒà·„ à¶¯à·”à¶»à¶šà¶®à¶± à¶…à¶‚à¶šà¶º à¶…à¶´à¶§ à¶¯à¶±à·Šà·€à¶±à·Šà¶±.";
              }
              
              if (lowerMessage.includes('lost') || lowerMessage.includes('item')) {
                return "For lost items, please:\n\n1. Call our 24/7 hotline: **1331**\n2. Provide your Trip ID and contact details\n\nOur team will coordinate with the driver to help recover your item.\n\nà·„à¶¯à·’à·ƒà·’ à·ƒà·„à¶º à·ƒà¶³à·„à·: 1331";
              }
              
              if (lowerMessage.includes('refund') || lowerMessage.includes('overcharge')) {
                return "For refund requests:\n\n1. Open the PickMe App\n2. Go to **My Trips** â†’ **Completed/Cancelled**\n3. Select the Trip ID\n4. Click **HELP/Complaint** button\n\nOur team will review and respond within 48 business hours.\n\nà¶†à¶´à·ƒà·” à¶œà·™à·€à·“à¶¸à·Š à·ƒà¶³à·„à· app à¶‘à¶šà·š 'My Trips' à¶·à·à·€à·’à¶­à· à¶šà¶»à¶±à·Šà¶±.";
              }
              
              return "I understand you need assistance. Could you please provide more details about:\n\nâ€¢ Trip complaints\nâ€¢ Lost items\nâ€¢ Refund issues\nâ€¢ Driver behavior concerns\n\nOr call our 24/7 hotline: **1331**\n\nà¶¯à·”à¶»à¶šà¶®à¶±: 1331 (24/7)";
            }
            
            return "I'm sorry, I'm having trouble connecting to the support system. Please try again or call our 24/7 hotline at 1331 for immediate assistance.";
          }
        };

        // ChatMessage Component
        const ChatMessage = ({ message }) => {
          const isModel = message.role === 'model';

          return (
            <div className={`flex ${isModel ? 'justify-start' : 'justify-end'} group`}>
              <div
                className={`max-w-[85%] rounded-3xl px-5 py-4 shadow-sm relative transition-all ${
                  isModel
                    ? 'bg-white text-slate-700 border border-slate-200 rounded-tl-none'
                    : 'bg-emerald-600 text-white rounded-tr-none shadow-emerald-100'
                }`}
              >
                <div className={`text-[10px] font-black uppercase tracking-tighter mb-1.5 opacity-60 flex items-center gap-1.5 ${isModel ? 'text-emerald-600' : 'text-emerald-100'}`}>
                  {isModel ? (
                    <>
                      <span className="w-1.5 h-1.5 bg-emerald-500 rounded-full"></span>
                      PickMe AI Support
                    </>
                  ) : (
                    'You'
                  )}
                </div>
                <div className="text-[14px] leading-relaxed font-medium whitespace-pre-wrap">
                  {message.text}
                </div>
                <div className={`text-[9px] mt-2 font-bold opacity-40 text-right uppercase tracking-widest`}>
                  {message.timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                </div>
              </div>
            </div>
          );
        };

        // Main App Component
        const App = () => {
          const [messages, setMessages] = useState([
            {
              role: 'model',
              text: "Hello! Welcome to PickMe Official Support. ðŸ‘‹\nHow can we help you with your trip or delivery today?\n\nà¶†à¶ºà·”à¶¶à·à·€à¶±à·Š! PickMe à¶±à·’à¶½ à·ƒà·„à¶º à·ƒà·šà·€à·à·€ à·€à·™à¶­ à·ƒà·à¶¯à¶»à¶ºà·™à¶±à·Š à¶´à·’à·…à·’à¶œà¶±à·’à¶¸à·”. à¶”à¶¶à¶œà·š à¶œà¶¸à¶± à·„à· à¶‡à¶«à·€à·”à¶¸ à·ƒà¶¸à·Šà¶¶à¶±à·Šà¶°à¶ºà·™à¶±à·Š à¶…à¶´à¶§ à¶”à¶¶à¶§ à·ƒà·„à¶º à·€à·’à¶º à·„à·à¶šà·Šà¶šà·š à¶šà·™à·ƒà·šà¶¯?",
              timestamp: new Date(),
            },
          ]);
          const [input, setInput] = useState('');
          const [isLoading, setIsLoading] = useState(false);
          const scrollRef = useRef(null);

          useEffect(() => {
            if (scrollRef.current) {
              scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
            }
          }, [messages, isLoading]);

          const handleSend = async (customText) => {
            const textToSend = customText || input.trim();
            if (!textToSend || isLoading) return;

            const userMessage = {
              role: 'user',
              text: textToSend,
              timestamp: new Date(),
            };

            setMessages((prev) => [...prev, userMessage]);
            setInput('');
            setIsLoading(true);

            const history = messages.map((m) => ({
              role: m.role,
              parts: [{ text: m.text }],
            }));

            const responseText = await getChatResponse(textToSend, history);

            const modelMessage = {
              role: 'model',
              text: responseText,
              timestamp: new Date(),
            };

            setMessages((prev) => [...prev, modelMessage]);
            setIsLoading(false);
          };

          const quickActions = [
            { label: "Trip Complaint", icon: "ðŸš—" },
            { label: "Lost Item", icon: "ðŸŽ’" },
            { label: "Refund Issue", icon: "ðŸ’¸" },
            { label: "Driver Behavior", icon: "ðŸ‘¤" }
          ];

          return (
            <div className="flex flex-col h-[100dvh] max-w-2xl mx-auto bg-slate-50 overflow-hidden md:h-[95vh] md:my-[2.5vh] md:rounded-3xl shadow-[0_20px_50px_rgba(0,0,0,0.1)] border border-slate-200">
              {/* Premium Header */}
              <header className="bg-[#00AA55] px-6 py-5 flex items-center justify-between text-white relative overflow-hidden">
                <div className="absolute -right-10 -top-10 w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>
                
                <div className="flex items-center gap-4 z-10">
                  <div className="w-12 h-12 bg-white rounded-2xl flex items-center justify-center p-1.5 shadow-lg border border-emerald-400 rotate-2">
                     <img 
                       src="https://upload.wikimedia.org/wikipedia/en/b/b3/PickMe_Logo.png" 
                       alt="PickMe" 
                       className="w-full h-full object-contain"
                       onError={(e) => { e.target.src = 'https://via.placeholder.com/100x100/00AA55/white?text=PM' }}
                     />
                  </div>
                  <div>
                    <h1 className="font-black text-xl leading-none mb-1">PickMe Support</h1>
                    <div className="flex items-center gap-2">
                      <span className="relative flex h-2 w-2">
                        <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-yellow-400 opacity-75"></span>
                        <span className="relative inline-flex rounded-full h-2 w-2 bg-yellow-400"></span>
                      </span>
                      <span className="text-[10px] font-bold uppercase tracking-wider opacity-90">AI Assistant Online</span>
                    </div>
                  </div>
                </div>
                
                <div className="text-right z-10 hidden sm:block">
                  <div className="text-[10px] font-bold opacity-70 uppercase">Urgent Hotline</div>
                  <div className="text-lg font-black text-yellow-300">1331</div>
                </div>
              </header>

              {/* Main Chat Area */}
              <div 
                ref={scrollRef}
                className="flex-1 overflow-y-auto p-4 md:p-6 bg-[#F8FAFC] space-y-6 scroll-smooth"
              >
                {messages.map((msg, i) => (
                  <ChatMessage key={i} message={msg} />
                ))}
                
                {isLoading && (
                  <div className="flex justify-start">
                    <div className="bg-white border border-slate-100 rounded-2xl px-5 py-3 shadow-sm flex items-center gap-3">
                      <div className="flex gap-1">
                        <div className="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-bounce [animation-delay:-0.3s]"></div>
                        <div className="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-bounce [animation-delay:-0.15s]"></div>
                        <div className="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-bounce"></div>
                      </div>
                      <span className="text-xs font-bold text-slate-400 uppercase tracking-widest">Typing...</span>
                    </div>
                  </div>
                )}
              </div>

              {/* Quick Actions Scroll */}
              {!isLoading && messages.length < 5 && (
                <div className="px-4 py-3 bg-white border-t border-slate-100 flex gap-2 overflow-x-auto no-scrollbar">
                  {quickActions.map((action) => (
                    <button
                      key={action.label}
                      onClick={() => handleSend(action.label)}
                      className="flex-shrink-0 bg-emerald-50 text-emerald-700 border border-emerald-100 px-4 py-2 rounded-full text-xs font-bold hover:bg-emerald-500 hover:text-white transition-all active:scale-95 flex items-center gap-2"
                    >
                      <span>{action.icon}</span>
                      {action.label}
                    </button>
                  ))}
                </div>
              )}

              {/* Modern Input Field */}
              <div className="p-4 bg-white border-t border-slate-100 pb-6 md:pb-8">
                <div className="relative group max-w-3xl mx-auto">
                  <textarea
                    value={input}
                    onChange={(e) => setInput(e.target.value)}
                    onKeyDown={(e) => {
                      if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        handleSend();
                      }
                    }}
                    placeholder="Describe your issue clearly..."
                    className="w-full rounded-2xl border-2 border-slate-100 focus:border-[#00AA55] focus:ring-0 min-h-[58px] max-h-32 py-4 pl-5 pr-14 resize-none transition-all text-sm font-medium placeholder:text-slate-400 shadow-sm"
                    rows={1}
                  />
                  <button
                    onClick={() => handleSend()}
                    disabled={!input.trim() || isLoading}
                    className={`absolute right-2.5 bottom-2.5 p-2 rounded-xl transition-all ${
                      !input.trim() || isLoading 
                        ? 'bg-slate-50 text-slate-300' 
                        : 'bg-[#00AA55] text-white shadow-lg shadow-emerald-200 hover:bg-emerald-600 active:scale-95'
                    }`}
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round">
                      <line x1="22" y1="2" x2="11" y2="13"></line>
                      <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                  </button>
                </div>
                <p className="mt-3 text-center text-[10px] font-bold text-slate-400 uppercase tracking-widest">
                  Secured Official Support Portal
                </p>
              </div>
            </div>
          );
        };

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>